# Workflow: Prepare Release

**Location:** `.github/workflows/prepare-release.yml`

---

## Purpose

Initiates the release process by automatically updating version numbers across all project files and creating a release PR from `develop` to `main`.

This workflow implements the first step of the automated GitHub Flow release pipeline.

---

## Trigger

```yaml
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.2.0)'
        required: true
        type: string
```

**Manual execution only** via GitHub Actions UI.

**Input format:** Semantic version without `v` prefix (e.g., `1.2.0`, `2.0.0`, `1.3.1`)

---

## What It Does

### 1. Validates Input

- Checks version format matches semantic versioning: `X.Y.Z` (numbers only)
- Verifies tag `vX.Y.Z` doesn't already exist in repository
- Fails early if validation fails

### 2. Updates Version in Files

Extracts current version from `pom.xml` and updates it in 5 files:

| File | Location | Pattern |
|------|----------|---------|
| `pom.xml` | Root | `<version>X.Y.Z</version>` |
| `README.md` | Root | `cv-api-X.Y.Z.jar`, `jac-api:X.Y.Z` |
| `OpenApiConfig.java` | `src/main/java/.../infrastructure/rest/config/` | `.version("X.Y.Z")` |
| `Dockerfile` | Root | `cv-api-X.Y.Z.jar` |
| `docker-compose.yml` | Root | `image: jac-api:X.Y.Z` |

**Implementation:** Uses `sed` with current version detection from pom.xml

### 3. Commits Changes

```bash
git commit -m "chore: bump version to X.Y.Z"
git push origin develop
```

**Author:** `github-actions[bot]`

### 4. Creates Release PR

Opens pull request with:
- **Base:** `main`
- **Head:** `develop`
- **Title:** `Release vX.Y.Z`
- **Label:** `release`
- **Body:** Auto-generated with:
  - List of updated files
  - Pre-merge checklist
  - Next steps instructions

---

## Permissions

```yaml
permissions:
  contents: write        # Push version update commit
  pull-requests: write   # Create PR
```

---

## Design Decisions

### Why Update Files Before PR?

Files are updated on `develop` before creating the PR so that:
- PR diff shows exactly what will be released
- Version is correct when PR is merged to `main`
- No need to update files after PR merge

### Why Commit to develop Directly?

The version bump commit is mechanical (no business logic), so it's safe to push directly to `develop` without a PR. This simplifies the flow.

### Why Use sed Instead of Maven Versions Plugin?

`sed` is simpler and works across all file types (YAML, Java, Markdown). Maven Versions Plugin only updates `pom.xml`.

### Why Extract Version from pom.xml?

`pom.xml` is the single source of truth for the current version. All other files derive from it.

---

## Usage

### Via GitHub Actions UI

```
1. GitHub → Actions → Prepare Release
2. Click: "Run workflow"
3. Branch: develop (default)
4. Input version: 1.2.0
5. Click: "Run workflow"
```

**Time:** ~30 seconds

### What Happens Next

1. Workflow completes → commit pushed to `develop`
2. PR created → `develop` → `main`
3. CI runs automatically on the PR
4. **You review the PR** (verify version updates, check CHANGELOG)
5. **You merge the PR** → triggers `auto-tag.yml`

---

## Example PR Created

**Title:** `Release v1.2.0`

**Body:**
```markdown
## Release v1.2.0

This PR prepares the release for version 1.2.0.

### Files Updated
- ✅ `pom.xml`
- ✅ `README.md`
- ✅ `OpenApiConfig.java`
- ✅ `Dockerfile`
- ✅ `docker-compose.yml`

### Checklist
- [ ] All tests passing in develop
- [ ] CHANGELOG.md updated manually (verify)
- [ ] Breaking changes documented (if any)

### Next Steps
1. Review this PR and verify all version updates
2. Merge to main (will automatically create tag and trigger release)
3. Release will be published automatically with:
   - JAR artifact
   - Docker image to GHCR
   - Auto-generated release notes

**Auto-generated by Prepare Release workflow**
```

---

## Prerequisites

### Before Running

1. **All features merged to develop**
   ```bash
   git checkout develop
   git pull
   # Ensure develop is stable and CI is green
   ```

2. **CHANGELOG.md updated manually**
   ```bash
   vim CHANGELOG.md
   # Add ## [1.2.0] - 2026-02-24 section
   git commit -m "docs: update CHANGELOG for v1.2.0"
   git push origin develop
   ```

3. **Decide version number**
   - MAJOR: Breaking changes (1.2.0 → 2.0.0)
   - MINOR: New features (1.2.0 → 1.3.0)
   - PATCH: Bug fixes (1.2.0 → 1.2.1)

---

## Error Handling

### Error: "Version must be semantic"

**Cause:** Input format is incorrect

**Examples:**
- ❌ `v1.2.0` (has `v` prefix)
- ❌ `1.2` (missing patch version)
- ❌ `release-1.2.0` (not semantic)
- ✅ `1.2.0` (correct)

### Error: "Tag vX.Y.Z already exists"

**Cause:** You're trying to release a version that's already been released

**Solution:** Use the next version number (e.g., 1.2.1 or 1.3.0)

### Workflow Succeeds but Version Not Updated

**Cause:** `sed` pattern didn't match file content

**Solution:** 
1. Check workflow logs for sed warnings
2. Verify file formats match expected patterns
3. Update workflow sed commands if file structure changed

---

## Troubleshooting

### PR Created but CI Fails

**This is expected behavior.** The PR triggers CI to run on the release branch. If CI fails:

1. Fix the issue in `develop`
2. Push the fix
3. PR will update automatically
4. CI will re-run

**Do not** cancel the PR. Fix the issue and let CI re-validate.

### Multiple Version Occurrences in README

If you added custom version references in README:

1. Update the sed command in the workflow
2. Or manually update those references before merging the PR

### PR Created Against Wrong Branch

**Cause:** Workflow was triggered from wrong branch

**Prevention:** Always run from `develop` branch (default in workflow)

**Solution:** Close the PR and re-run from `develop`

---

## Related Workflows

| Workflow | Relationship |
|----------|--------------|
| `ci.yml` | Runs on the PR created by this workflow |
| `auto-tag.yml` | Triggered when the PR is merged |
| `release.yml` | Triggered by the tag created by auto-tag |

---

## Next Steps After Running

1. **Wait for workflow to complete** (~30 seconds)
2. **Navigate to Pull Requests** tab
3. **Find PR:** "Release vX.Y.Z"
4. **Wait for CI** to complete on the PR (~3 minutes)
5. **Review changes** in Files tab
6. **Verify CHANGELOG.md** is present and correct
7. **Merge PR** when satisfied → automatic tag creation

---

## Advanced: Pre-release Versions

For beta, RC, or alpha releases:

```
Version input: 1.3.0-beta
PR title: Release v1.3.0-beta
Tag created: v1.3.0-beta
GitHub Release: Marked as "Pre-release"
```

Pre-releases follow the same flow but are marked differently in GitHub Releases.

---

## See Also

- `auto-tag.yml` - Automatic tag creation on PR merge
- `release.yml` - Release automation workflow
- `automated-release-flow.md` - Complete release flow guide
- `RELEASE_GUIDE.md` - Quick release reference
